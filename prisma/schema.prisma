// Prisma Schema for ERP System
// 企业资源规划系统数据库设计

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==================== 用户认证模块 ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          UserRole  @default(EMPLOYEE)
  avatar        String?
  phone         String?
  department    String?
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // 关系
  orders        Order[]
  purchases     Purchase[]
  activities    Activity[]
  sessions      Session[]
  notifications Notification[]
  managedWarehouses Warehouse[]

  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

enum UserRole {
  ADMIN        // 管理员
  MANAGER      // 经理
  SALES        // 销售
  PURCHASE     // 采购
  WAREHOUSE    // 仓库
  FINANCE      // 财务
  EMPLOYEE     // 普通员工
}

// ==================== 产品目录模块 ====================

model Category {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  parentId    String?
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[]

  @@map("categories")
}

model Product {
  id            String      @id @default(cuid())
  sku           String      @unique
  barcode       String?     @unique
  name          String
  description   String?
  categoryId    String
  category      Category    @relation(fields: [categoryId], references: [id])
  unit          String      @default("个")  // 计量单位
  costPrice     Decimal     @db.Decimal(10, 2)  // 成本价
  sellPrice     Decimal     @db.Decimal(10, 2)  // 销售价
  minPrice      Decimal?    @db.Decimal(10, 2)  // 最低售价
  weight        Decimal?    @db.Decimal(10, 3)  // 重量(kg)
  images        String?     @db.Text   // 产品图片URLs (JSON格式)
  isActive      Boolean     @default(true)
  isFeatured    Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // 关系
  inventory     Inventory?
  orderItems    OrderItem[]
  purchaseItems PurchaseItem[]
  BOMs          BillOfMaterial[]  // 物料清单（成品）
  BOMItems      BillOfMaterialItem[]  // 物料清单（子件）

  @@map("products")
}

model BillOfMaterial {
  id          String              @id @default(cuid())
  productId   String              // 成品ID
  product     Product             @relation(fields: [productId], references: [id])
  name        String
  version     String              @default("1.0")
  description String?
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  items       BillOfMaterialItem[]

  @@unique([productId, version])
  @@map("bill_of_materials")
}

model BillOfMaterialItem {
  id              String          @id @default(cuid())
  bomId           String
  bom             BillOfMaterial  @relation(fields: [bomId], references: [id], onDelete: Cascade)
  componentId     String          // 子件ID
  component       Product         @relation(fields: [componentId], references: [id])
  quantity        Decimal         @db.Decimal(10, 3)  // 用量
  unit            String          @default("个")
  wasteRate       Decimal         @default(0) @db.Decimal(5, 2)  // 损耗率%

  @@map("bill_of_material_items")
}

// ==================== 库存管理模块 ====================

model Warehouse {
  id          String      @id @default(cuid())
  code        String      @unique
  name        String
  address     String?
  contact     String?
  phone       String?
  managerId   String?
  manager     User?       @relation(fields: [managerId], references: [id])
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  inventories Inventory[]
  movements   InventoryMovement[]

  @@map("warehouses")
}

model Inventory {
  id            String      @id @default(cuid())
  productId     String      @unique
  product       Product     @relation(fields: [productId], references: [id])
  warehouseId   String
  warehouse     Warehouse   @relation(fields: [warehouseId], references: [id])
  quantity      Int         @default(0)  // 当前库存
  reservedQty   Int         @default(0)  // 预留数量
  reorderPoint  Int         @default(10)  //  reorder point
  safetyStock   Int         @default(5)   // 安全库存
  location      String?     // 库位
  lastCheckAt   DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  movements     InventoryMovement[]

  @@unique([productId, warehouseId])
  @@map("inventory")
}

model InventoryMovement {
  id            String          @id @default(cuid())
  inventoryId   String
  inventory     Inventory       @relation(fields: [inventoryId], references: [id])
  warehouseId   String
  warehouse     Warehouse       @relation(fields: [warehouseId], references: [id])
  type          MovementType
  quantity      Int             // 变动数量（正数入库，负数出库）
  referenceType String?         // 来源类型：order/purchase/adjustment
  referenceId   String?         // 来源ID
  note          String?
  operatorId    String
  createdAt     DateTime        @default(now())

  @@map("inventory_movements")
}

enum MovementType {
  PURCHASE_IN       // 采购入库
  SALE_OUT          // 销售出库
  RETURN_IN         // 退货入库
  TRANSFER_IN       // 调拨入库
  TRANSFER_OUT      // 调拨出库
  ADJUSTMENT_IN     // 盘盈入库
  ADJUSTMENT_OUT    // 盘亏出库
  PRODUCTION_IN     // 生产入库
  PRODUCTION_OUT    // 领料出库
}

// ==================== 销售订单模块 ====================

model Customer {
  id            String      @id @default(cuid())
  code          String      @unique
  name          String
  type          CustomerType @default(COMPANY)
  email         String?
  phone         String?
  address       String?
  taxNumber     String?     // 税号
  bankAccount   String?     // 银行账户
  creditLimit   Decimal     @default(0) @db.Decimal(10, 2)
  creditDays    Int         @default(30)  // 账期（天）
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  orders        Order[]

  @@map("customers")
}

enum CustomerType {
  COMPANY       // 企业
  INDIVIDUAL    // 个人
}

model Order {
  id            String        @id @default(cuid())
  orderNumber   String        @unique
  customerId    String
  customer      Customer      @relation(fields: [customerId], references: [id])
  status        OrderStatus   @default(DRAFT)
  totalAmount   Decimal       @db.Decimal(12, 2)
  discount      Decimal       @default(0) @db.Decimal(12, 2)
  taxRate       Decimal       @default(0) @db.Decimal(5, 2)
  taxAmount     Decimal       @default(0) @db.Decimal(12, 2)
  finalAmount   Decimal       @db.Decimal(12, 2)
  orderDate     DateTime      @default(now())
  deliveryDate  DateTime?
  deliveryAddress String?
  note          String?
  salesPersonId String?
  salesPerson   User?         @relation(fields: [salesPersonId], references: [id])
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  items         OrderItem[]

  @@map("orders")
}

enum OrderStatus {
  DRAFT         // 草稿
  CONFIRMED     // 已确认
  PROCESSING    // 处理中
  SHIPPED       // 已发货
  DELIVERED     // 已送达
  COMPLETED     // 已完成
  CANCELLED     // 已取消
}

model OrderItem {
  id          String    @id @default(cuid())
  orderId     String
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product   @relation(fields: [productId], references: [id])
  quantity    Int
  unitPrice   Decimal   @db.Decimal(10, 2)
  discount    Decimal   @default(0) @db.Decimal(10, 2)
  taxRate     Decimal   @default(0) @db.Decimal(5, 2)
  amount      Decimal   @db.Decimal(12, 2)
  note        String?
  createdAt   DateTime  @default(now())

  @@map("order_items")
}

// ==================== 采购管理模块 ====================

model Supplier {
  id            String      @id @default(cuid())
  code          String      @unique
  name          String
  contactPerson String?
  email         String?
  phone         String?
  address       String?
  taxNumber     String?
  bankAccount   String?
  leadTime      Int         @default(7)  // 交货周期（天）
  minOrderQty   Int         @default(1)  // 最小订单量
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  purchases     Purchase[]

  @@map("suppliers")
}

model Purchase {
  id            String          @id @default(cuid())
  purchaseNumber String         @unique
  supplierId    String
  supplier      Supplier        @relation(fields: [supplierId], references: [id])
  status        PurchaseStatus  @default(DRAFT)
  totalAmount   Decimal         @db.Decimal(12, 2)
  taxAmount     Decimal         @default(0) @db.Decimal(12, 2)
  finalAmount   Decimal         @db.Decimal(12, 2)
  orderDate     DateTime        @default(now())
  expectedDate  DateTime?
  receivedDate  DateTime?
  warehouseId   String?
  note          String?
  purchaserId   String?
  purchaser     User?           @relation(fields: [purchaserId], references: [id])
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  items         PurchaseItem[]

  @@map("purchases")
}

enum PurchaseStatus {
  DRAFT         // 草稿
  SUBMITTED     // 已提交
  CONFIRMED     // 已确认
  SHIPPED       // 已发货
  PARTIAL       // 部分到货
  RECEIVED      // 已到货
  COMPLETED     // 已完成
  CANCELLED     // 已取消
}

model PurchaseItem {
  id          String    @id @default(cuid())
  purchaseId  String
  purchase    Purchase  @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  productId   String
  product     Product   @relation(fields: [productId], references: [id])
  quantity    Int
  unitPrice   Decimal   @db.Decimal(10, 2)
  taxRate     Decimal   @default(0) @db.Decimal(5, 2)
  amount      Decimal   @db.Decimal(12, 2)
  receivedQty Int       @default(0)
  note        String?
  createdAt   DateTime  @default(now())

  @@map("purchase_items")
}

// ==================== 财务模块 ====================

model Account {
  id          String      @id @default(cuid())
  code        String      @unique
  name        String
  type        AccountType
  parentId    String?
  parent      Account?    @relation("AccountHierarchy", fields: [parentId], references: [id])
  children    Account[]   @relation("AccountHierarchy")
  balance     Decimal     @default(0) @db.Decimal(14, 2)
  isSystem    Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  transactions Transaction[]

  @@map("accounts")
}

enum AccountType {
  ASSET       // 资产
  LIABILITY   // 负债
  EQUITY      // 权益
  REVENUE     // 收入
  EXPENSE     // 费用
}

model Transaction {
  id          String      @id @default(cuid())
  voucherNo   String      @unique  // 凭证号
  date        DateTime
  type        TransactionType
  accountId   String
  account     Account     @relation(fields: [accountId], references: [id])
  amount      Decimal     @db.Decimal(14, 2)
  direction   TransactionDirection
  referenceType String?   // 来源类型
  referenceId String?     // 来源ID
  description String
  createdAt   DateTime    @default(now())

  @@map("transactions")
}

enum TransactionType {
  SALES_REVENUE      // 销售收入
  PURCHASE_EXPENSE   // 采购支出
  SALES_RETURN       // 销售退货
  PURCHASE_RETURN    // 采购退货
  OTHER_INCOME       // 其他收入
  OTHER_EXPENSE      // 其他支出
}

enum TransactionDirection {
  DEBIT     // 借方
  CREDIT    // 贷方
}

// ==================== 报表与活动日志 ====================

model Activity {
  id          String      @id @default(cuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id])
  action      String
  entityType  String
  entityId    String
  details     String?     @db.Text
  ipAddress   String?
  createdAt   DateTime    @default(now())

  @@index([entityType, entityId])
  @@map("activities")
}

model Report {
  id          String    @id @default(cuid())
  name        String
  type        ReportType
  config      String    @db.Text  // 报表配置JSON
  isPublic    Boolean   @default(false)
  createdById String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("reports")
}

enum ReportType {
  SALES_SUMMARY          // 销售汇总
  SALES_DETAIL           // 销售明细
  PURCHASE_SUMMARY       // 采购汇总
  PURCHASE_DETAIL        // 采购明细
  INVENTORY_STATUS       // 库存状态
  INVENTORY_MOVEMENT     // 库存变动
  PROFIT_LOSS            // 损益表
  CUSTOMER_STAT          // 客户统计
  SUPPLIER_STAT          // 供应商统计
}

// ==================== 消息通知 ====================

model Notification {
  id          String            @id @default(cuid())
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        NotificationType
  title       String
  content     String            @db.Text
  link        String?
  isRead      Boolean           @default(false)
  readAt      DateTime?
  createdAt   DateTime          @default(now())

  @@index([userId, isRead])
  @@map("notifications")
}

enum NotificationType {
  SYSTEM           // 系统通知
  ORDER            // 订单相关
  PURCHASE         // 采购相关
  INVENTORY        // 库存相关
  FINANCE          // 财务相关
  MENTION          // @提及
}
